# Remove the version: '3' line if you still have it - it's obsolete

# Development override - enables hot reloading but disables Docker layer caching
services:
  bianca-app:
    build: 
      context: .
      dockerfile: Dockerfile
      target: build  # Use build stage which has node_modules installed
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - USE_SES_IN_DEV=${USE_SES_IN_DEV:-false}  # Default to Ethereal for local dev (set to true if you want SES)
      - AWS_PROFILE=${AWS_PROFILE:-jordan}
      - AWS_REGION=${AWS_REGION:-us-east-2}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:8081}
      # Unset placeholder credentials to avoid conflicts with AWS_PROFILE
      - AWS_ACCESS_KEY_ID=
      - AWS_SECRET_ACCESS_KEY=
    volumes:
      # Mount source code - in dev mode, we'll fix permissions in entrypoint
      - .:/usr/src/bianca-app
      # Use named volume for node_modules to avoid permission issues
      - bianca-app-node-modules:/usr/src/bianca-app/node_modules
      - /home/jordanlapp/.aws:/home/node/.aws:ro  # Mount AWS config and SSO cache for SES access (node user)
    working_dir: /usr/src/bianca-app
    # Start as root so entrypoint can fix permissions before switching to node user
    user: "0:0"
    entrypoint: ["/usr/src/bianca-app/docker-entrypoint.sh"]
    # In dev mode, install dependencies first, then run dev server
    command: ["sh", "-c", "yarn install --pure-lockfile --frozen-lockfile && yarn dev"]
    ports:
      - "9229:9229"
    cap_add:
    - NET_RAW
    - NET_ADMIN
    # Add other necessary configurations like build context, volumes, etc.
    networks: # <-- Add this network assignment
      - node-network

  # ngrok:
  #   container_name: ngrok
  #   image: ngrok/ngrok
  #   restart: unless-stopped
  #   depends_on:
  #     - bianca-app
  #     - asterisk
  #   ports:
  #     - '4040:4040'
  #   environment:
  #     - NGROK_AUTHTOKEN=${NGROK_AUTHTOKEN} # Make sure this is set in your .env file
  #   volumes:
  #     # Mount the config file into the container
  #     - ./devops/ngrok-configs/ngrok.yml:/etc/ngrok/ngrok.yml # Mount as read-only
  #   # Use the config file to start ALL defined tunnels
  #   command: start --all --config /etc/ngrok/ngrok.yml
  #   networks: # <-- Ensure this network assignment exists
  #     - node-network

 # --- Add the frpc service ---
  # frpc:
  #   container_name: frpc
  #   image: snowdreamtech/frpc # Using a popular frpc image
  #   restart: unless-stopped
  #   networks:
  #     - node-network
  #   volumes:
  #     # Mount your local frpc.ini into the container
  #     - ./devops/frp/configs/frpc.toml:/etc/frp/frpc.toml:ro
  #   command: -c /etc/frp/frpc.toml # Command to run frpc with the config
  #   depends_on:
  #     # Ensure asterisk is running before frpc tries to forward to it
  #     asterisk:
  #       condition: service_healthy # Wait for Asterisk healthcheck

  asterisk:
    # You don't need to redefine build, environment, ports if they are
    # correctly set in your main docker-compose.yml and you don't want to change them for dev.
    # We are just adding/merging the volumes section here.
    volumes:
      # This will be merged with any volumes defined in the main docker-compose.yml for asterisk
      - ./devops/asterisk/recordings:/var/spool/asterisk/recording # Mount for recordings

# Define the network at the top level
networks: # <-- Add this whole block
  node-network:
    driver: bridge # Use the default bridge driver

# Define volumes
volumes:
  bianca-app-node-modules: