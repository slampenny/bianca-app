version: 0.2

phases:
  pre_build:
    commands:
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
      - echo Build started on `date`
      - echo Building Docker images...

  build:
    commands:
      - echo Building backend image...
      - cd backend
      - docker build -t $ECR_REGISTRY/bianca-backend:latest -t $ECR_REGISTRY/bianca-backend:$CODEBUILD_RESOLVED_SOURCE_VERSION .
      - docker push $ECR_REGISTRY/bianca-backend:latest
      - docker push $ECR_REGISTRY/bianca-backend:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - cd ..
      - echo Building frontend image...
      - cd frontend
      - docker build -t $ECR_REGISTRY/bianca-frontend:latest -t $ECR_REGISTRY/bianca-frontend:$CODEBUILD_RESOLVED_SOURCE_VERSION .
      - docker push $ECR_REGISTRY/bianca-frontend:latest
      - docker push $ECR_REGISTRY/bianca-frontend:$CODEBUILD_RESOLVED_SOURCE_VERSION
      - cd ..

  post_build:
    commands:
      - echo Build completed on `date`
      - echo Preparing CodeDeploy artifacts...
      - |
        # Copy CodeDeploy files to artifact output directory
        # CodeDeploy expects appspec.yml and scripts/ in the artifact root
        # The artifact output directory is automatically created by CodeBuild
        cp -r $CODEBUILD_SRC_DIR/backend/devops/codedeploy/* .
        
        echo "CodeDeploy artifacts prepared:"
        ls -la
        echo "appspec.yml location:"
        cat appspec.yml | head -5

artifacts:
  files:
    - '**/*'
  name: BuildOutput

