[from-twilio]
exten => bianca,1,NoOp(Incoming call to bianca exten)
  ; Read the To header (less reliable than Request-URI for parameters)
  same => n,Set(TO_HEADER_RAW=${PJSIP_HEADER(read,To)})
  same => n,NoOp(Raw To Header: ${TO_HEADER_RAW})
  ; Filter potentially problematic characters (use with caution)
  same => n,Set(TO_HEADER_FILTERED=${FILTER(0-9a-zA-Z@._\-=+&:/\;,${TO_HEADER_RAW})})
  ; Attempt to extract key=value pairs using semicolon delimiter (FRAGILE!)
  same => n,Set(CALLSID_PAIR=${CUT(TO_HEADER_FILTERED,\;,2)}) ; e.g., "callSid=CA..."
  same => n,Set(PATIENTID_PAIR=${CUT(TO_HEADER_FILTERED,\;,3)}) ; e.g., "patientId=680c..."
  same => n,NoOp(Extracted Pair 1 (CallSid?): ${CALLSID_PAIR})
  same => n,NoOp(Extracted Pair 2 (PatientId?): ${PATIENTID_PAIR})
  ; --- FIX: Extract VALUE part using '=' delimiter ---
  same => n,Set(CALLSID_VALUE=${CUT(CALLSID_PAIR,=,2)})     ; Extracts value after '='
  same => n,Set(PATIENTID_VALUE=${CUT(PATIENTID_PAIR,=,2)}) ; Extracts value after '='
  same => n,NoOp(Extracted Value 1 (CallSid): ${CALLSID_VALUE})
  same => n,NoOp(Extracted Value 2 (PatientId): ${PATIENTID_VALUE})
  ; --- FIX: Construct URIOPTS using VALUES only ---
  same => n,Set(URIOPTS=callSid=${CALLSID_VALUE}&patientId=${PATIENTID_VALUE})
  same => n,NoOp(Final Constructed URIOPTS = ${URIOPTS})
  ; --- Send to Stasis ---
  same => n,Verbose(1,ğŸ’¥ Incoming Twilio Call: callSid=${CALLSID_VALUE}, patientId=${PATIENTID_VALUE})
  same => n,Stasis(myphonefriend) ; ARI client will read channel variable URIOPTS
  same => n,Hangup()

[bianca-app]
exten => _X.,1,NoOp(Outgoing call from Bianca: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@twilio-trunk)
 same => n,Hangup()

[unauthorized]
exten => _X.,1,NoOp(ğŸš« Unauthorized SIP attempt from ${CALLERID(all)})
 same => n,Hangup()

