[from-twilio]
exten => bianca,1,NoOp(Incoming call to bianca exten)
  ; Read the To header (less reliable than Request-URI for parameters)
  same => n,Set(TO_HEADER_RAW=${PJSIP_HEADER(read,To)})
  same => n,NoOp(Raw To Header: ${TO_HEADER_RAW})
  ; Filter potentially problematic characters (use with caution)
  same => n,Set(TO_HEADER_FILTERED=${FILTER(0-9a-zA-Z@._\-=+&:/\;,${TO_HEADER_RAW})})
  ; Attempt to extract key=value pairs using semicolon delimiter (FRAGILE!)
  same => n,Set(CALLSID_PAIR=${CUT(TO_HEADER_FILTERED,\;,2)}) ; e.g., "callSid=CA..."
  same => n,Set(PATIENTID_PAIR=${CUT(TO_HEADER_FILTERED,\;,3)}) ; e.g., "patientId=680c..."
  same => n,NoOp(Extracted Pair 1 (CallSid?): ${CALLSID_PAIR})
  same => n,NoOp(Extracted Pair 2 (PatientId?): ${PATIENTID_PAIR})
  ; --- FIX: Extract VALUE part using '=' delimiter ---
  same => n,Set(CALLSID_VALUE=${CUT(CALLSID_PAIR,=,2)})     ; Extracts value after '='
  same => n,Set(PATIENTID_VALUE=${CUT(PATIENTID_PAIR,=,2)}) ; Extracts value after '='
  same => n,NoOp(Extracted Value 1 (CallSid): ${CALLSID_VALUE})
  same => n,NoOp(Extracted Value 2 (PatientId): ${PATIENTID_VALUE})
  ; --- FIX: Construct URIOPTS using VALUES only ---
  same => n,Set(URIOPTS=callSid=${CALLSID_VALUE}&patientId=${PATIENTID_VALUE})
  same => n,NoOp(Final Constructed URIOPTS = ${URIOPTS})
  ; --- Send to Stasis ---
  same => n,Stasis(myphonefriend) ; ARI client will read channel variable URIOPTS
  same => n,Hangup()

[bianca-app]
exten => _X.,1,NoOp(Outgoing call from Bianca: ${EXTEN})
 same => n,Dial(PJSIP/${EXTEN}@twilio-trunk)
 same => n,Hangup()

[internal-audiosocket-context]

;=======================================================================
; Extension to handle the initially originated Local channel
; The UUID is part of the extension name dialed by ARI originate
; Example: ARI dials Local/a1b2c3d4...@internal-audiosocket-context
;=======================================================================
exten => _[0-9a-fA-F].,1,NoOp(Local channel ${CHANNEL(name)} entering Stasis for AudioSocket setup)
    ; Use same => n, Pattern to refer to the next priority of the *matched* extension (_[0-9a-fA-F].)
    ; The EXTEN variable will hold the UUID dialed by ARI.
    same => n,NoOp(Dialed extension (UUID) is: ${EXTEN})
    ; Send the channel into our main Stasis application ('myphonefriend')
    ; Pass the specific argument 'audiosocket_local_leg' so the Node.js StasisStart handler can identify it.
    same => n,Stasis(myphonefriend,audiosocket_local_leg)
    ; Execution should NOT normally return here from Stasis if Node.js calls continueInDialplan properly.
    ; If it does, it means Node.js might have released control without specifying the next step.
    same => n,NoOp(WARN: Returned unexpectedly from Stasis for ${CHANNEL(name)}. Hanging up.)
    same => n,Hangup()

;=======================================================================
; Extension targeted by Node.js 'continueInDialplan' after ARI bridging
;=======================================================================
exten => audiosocket,1,NoOp(Local channel ${CHANNEL(name)} continuing to AudioSocket execution)
    ; Ensure channel is answered
    same => n,Answer()
    ; Extract the UUID from the channel name (e.g., "Local/uuid@context/n")
    ; Use CUT: Get field 2 using '/' delimiter -> "uuid@context/n"
    ; Use CUT: Get field 1 using '@' delimiter -> "uuid"
    same => n,Set(UUID_FROM_NAME=${CUT(CUT(CHANNEL(name),/,2),@,1)})
    same => n,NoOp(Extracted UUID from channel name: ${UUID_FROM_NAME})

    ; ** IMPORTANT: Define your WebSocket server URI here **
    ; Replace 'your_websocket_server_host', 'port', and '/path'
    ; We pass the extracted UUID as a query parameter.
    same => n,Set(WEBSOCKET_URI=ws://bianca-app:9099/audio?uuid=${UUID_FROM_NAME})
    same => n,NoOp(Connecting AudioSocket to: ${WEBSOCKET_URI})

    ; Execute AudioSocket - it blocks until WebSocket disconnects or channel hangs up
    ; You might need options like direction/format depending on your WS server needs:
    ; AudioSocket(${WEBSOCKET_URI},read) - Check Asterisk docs for exact options
    same => n,AudioSocket(${WEBSOCKET_URI})

    ; Execution continues here after AudioSocket finishes
    same => n,NoOp(AudioSocket finished for ${CHANNEL(name)})
    same => n,Hangup()

;=======================================================================
; Hangup handler for debugging
;=======================================================================
h => 1, NoOp(Hangup detected in internal-audiosocket-context for ${CHANNEL(name)})
    ; Add any desired cleanup or logging on hangup