// src/services/ai/financialExploitationDetector.service.js

const natural = require('natural');
const logger = require('../../config/logger');

/**
 * Financial Exploitation Detector Service
 * Detects patterns indicating financial fraud or exploitation
 */
class FinancialExploitationDetector {
  constructor() {
    this.tokenizer = new natural.WordTokenizer();
    this.sentenceTokenizer = new natural.SentenceTokenizer();
    
    // Financial exploitation indicators
    this.financialKeywords = {
      // Money amounts and transfers
      largeAmounts: [
        /\b(\$?\d{1,3}(?:,\d{3})*(?:\.\d{2})?)\s*(thousand|million|grand|k|m)\b/i,
        /\b(ten|twenty|thirty|fifty|hundred|thousand|million)\s*(dollars?|bucks?)\b/i,
        /\b\d{4,}\s*(dollars?|bucks?)\b/i
      ],
      transferMethods: [
        'wire transfer', 'western union', 'moneygram', 'gift card', 'prepaid card',
        'bitcoin', 'cryptocurrency', 'venmo', 'paypal', 'zelle', 'cash app',
        'money order', 'cashier check', 'certified check'
      ],
      // Scam patterns
      scamIndicators: [
        'prize', 'lottery', 'winner', 'you won', 'congratulations',
        'irs', 'tax', 'social security', 'medicare', 'government',
        'arrest warrant', 'suspended', 'expired', 'verify',
        'nigerian prince', 'inheritance', 'unclaimed money',
        'tech support', 'microsoft', 'apple', 'amazon refund'
      ],
      // Pressure tactics
      urgencyLanguage: [
        'act now', 'urgent', 'immediately', 'today only', 'limited time',
        'don\'t tell anyone', 'keep this secret', 'confidential',
        'this is your last chance', 'expires today', 'deadline'
      ],
      // Financial help requests
      helpRequests: [
        'need money', 'loan', 'borrow', 'lend me', 'can you send',
        'emergency money', 'help with bills', 'behind on payments',
        'need cash', 'short on money', 'financial trouble'
      ],
      // New relationships asking for money
      relationshipMoney: [
        'new friend', 'met someone', 'someone i know', 'person i met',
        'they need help', 'they asked for', 'they want me to send'
      ]
    };

    // Weights for different indicators
    this.weights = {
      largeAmounts: 0.25,
      transferMethods: 0.20,
      scamIndicators: 0.30,
      urgencyLanguage: 0.15,
      helpRequests: 0.10
    };
  }

  /**
   * Detect financial exploitation patterns
   * @param {Array} patientMessages - Array of patient message strings
   * @param {string} combinedText - Combined text from all messages
   * @returns {Object} Financial exploitation analysis results
   */
  detectFinancialExploitation(patientMessages, combinedText) {
    try {
      if (!patientMessages || patientMessages.length === 0) {
        return this.getDefaultMetrics();
      }

      const lowerText = combinedText.toLowerCase();
      
      // Analyze different indicators
      const largeAmountAnalysis = this.analyzeLargeAmounts(combinedText);
      const transferMethodAnalysis = this.analyzeTransferMethods(lowerText);
      const scamIndicatorAnalysis = this.analyzeScamIndicators(lowerText);
      const urgencyAnalysis = this.analyzeUrgencyLanguage(lowerText);
      const helpRequestAnalysis = this.analyzeHelpRequests(lowerText);
      const relationshipMoneyAnalysis = this.analyzeRelationshipMoney(lowerText);

      // Calculate risk score
      const riskScore = this.calculateRiskScore({
        largeAmounts: largeAmountAnalysis,
        transferMethods: transferMethodAnalysis,
        scamIndicators: scamIndicatorAnalysis,
        urgencyLanguage: urgencyAnalysis,
        helpRequests: helpRequestAnalysis,
        relationshipMoney: relationshipMoneyAnalysis
      });

      // Detect temporal patterns (escalation over time)
      const temporalPatterns = this.analyzeTemporalPatterns(patientMessages);

      // Generate indicators
      const indicators = this.generateIndicators({
        largeAmounts: largeAmountAnalysis,
        transferMethods: transferMethodAnalysis,
        scamIndicators: scamIndicatorAnalysis,
        urgencyLanguage: urgencyAnalysis,
        helpRequests: helpRequestAnalysis,
        relationshipMoney: relationshipMoneyAnalysis,
        temporalPatterns
      });

      return {
        riskScore: Math.round(riskScore * 100) / 100,
        confidence: this.calculateConfidence(combinedText.length, patientMessages.length),
        indicators,
        largeAmountMentions: largeAmountAnalysis.count,
        transferMethodMentions: transferMethodAnalysis.count,
        scamIndicatorMentions: scamIndicatorAnalysis.count,
        urgencyMentions: urgencyAnalysis.count,
        helpRequestMentions: helpRequestAnalysis.count,
        relationshipMoneyMentions: relationshipMoneyAnalysis.count,
        temporalPatterns,
        flaggedPhrases: [
          ...largeAmountAnalysis.phrases,
          ...transferMethodAnalysis.phrases,
          ...scamIndicatorAnalysis.phrases,
          ...urgencyAnalysis.phrases
        ].slice(0, 10) // Limit to top 10
      };
    } catch (error) {
      logger.error('Error in FinancialExploitationDetector:', error);
      return this.getDefaultMetrics();
    }
  }

  /**
   * Analyze mentions of large amounts of money
   */
  analyzeLargeAmounts(text) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.largeAmounts.forEach(pattern => {
      const found = text.match(new RegExp(pattern.source || pattern, 'gi'));
      if (found) {
        matches.push(...found);
        phrases.push(...found);
      }
    });

    const words = this.tokenizer.tokenize(text) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)].slice(0, 5)
    };
  }

  /**
   * Analyze mentions of money transfer methods
   */
  analyzeTransferMethods(lowerText) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.transferMethods.forEach(keyword => {
      const regex = new RegExp(`\\b${keyword.replace(/\s+/g, '\\s+')}\\b`, 'gi');
      const found = lowerText.match(regex);
      if (found) {
        matches.push(...found);
        phrases.push(keyword);
      }
    });

    const words = this.tokenizer.tokenize(lowerText) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)]
    };
  }

  /**
   * Analyze scam indicator keywords
   */
  analyzeScamIndicators(lowerText) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.scamIndicators.forEach(keyword => {
      const regex = new RegExp(`\\b${keyword.replace(/\s+/g, '\\s+')}\\b`, 'gi');
      const found = lowerText.match(regex);
      if (found) {
        matches.push(...found);
        phrases.push(keyword);
      }
    });

    const words = this.tokenizer.tokenize(lowerText) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)]
    };
  }

  /**
   * Analyze urgency/pressure language
   */
  analyzeUrgencyLanguage(lowerText) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.urgencyLanguage.forEach(phrase => {
      const regex = new RegExp(phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const found = lowerText.match(regex);
      if (found) {
        matches.push(...found);
        phrases.push(phrase);
      }
    });

    const words = this.tokenizer.tokenize(lowerText) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)]
    };
  }

  /**
   * Analyze help requests
   */
  analyzeHelpRequests(lowerText) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.helpRequests.forEach(phrase => {
      const regex = new RegExp(phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const found = lowerText.match(regex);
      if (found) {
        matches.push(...found);
        phrases.push(phrase);
      }
    });

    const words = this.tokenizer.tokenize(lowerText) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)]
    };
  }

  /**
   * Analyze mentions of new relationships asking for money
   */
  analyzeRelationshipMoney(lowerText) {
    const matches = [];
    const phrases = [];
    
    this.financialKeywords.relationshipMoney.forEach(phrase => {
      const regex = new RegExp(phrase.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
      const found = lowerText.match(regex);
      if (found) {
        matches.push(...found);
        phrases.push(phrase);
      }
    });

    const words = this.tokenizer.tokenize(lowerText) || [];
    const density = words.length > 0 ? matches.length / words.length : 0;

    return {
      count: matches.length,
      density,
      phrases: [...new Set(phrases)]
    };
  }

  /**
   * Analyze temporal patterns (escalation over time)
   */
  analyzeTemporalPatterns(messages) {
    if (messages.length < 3) {
      return { hasEscalation: false, trend: 'insufficient_data' };
    }

    // Simple analysis: count financial mentions per message
    const financialMentions = messages.map((msg, idx) => {
      const lowerMsg = msg.toLowerCase();
      let count = 0;
      
      [...this.financialKeywords.transferMethods, 
       ...this.financialKeywords.scamIndicators,
       ...this.financialKeywords.urgencyLanguage].forEach(keyword => {
        const regex = new RegExp(`\\b${keyword.replace(/\s+/g, '\\s+')}\\b`, 'gi');
        if (lowerMsg.match(regex)) count++;
      });
      
      return { index: idx, count };
    });

    // Check for increasing trend
    const recent = financialMentions.slice(-5);
    const earlier = financialMentions.slice(0, Math.max(1, Math.floor(financialMentions.length / 2)));
    
    const recentAvg = recent.reduce((sum, m) => sum + m.count, 0) / recent.length;
    const earlierAvg = earlier.reduce((sum, m) => sum + m.count, 0) / earlier.length;

    return {
      hasEscalation: recentAvg > earlierAvg * 1.5,
      trend: recentAvg > earlierAvg ? 'increasing' : recentAvg < earlierAvg ? 'decreasing' : 'stable',
      recentAverage: recentAvg,
      earlierAverage: earlierAvg
    };
  }

  /**
   * Calculate overall risk score
   */
  calculateRiskScore(analyses) {
    let score = 0;
    let totalWeight = 0;

    // Large amounts (weighted by count)
    if (analyses.largeAmounts.count > 0) {
      const amountScore = Math.min(analyses.largeAmounts.count * 10, 100);
      score += amountScore * this.weights.largeAmounts;
      totalWeight += this.weights.largeAmounts;
    }

    // Transfer methods
    if (analyses.transferMethods.count > 0) {
      const transferScore = Math.min(analyses.transferMethods.count * 15, 100);
      score += transferScore * this.weights.transferMethods;
      totalWeight += this.weights.transferMethods;
    }

    // Scam indicators
    if (analyses.scamIndicators.count > 0) {
      const scamScore = Math.min(analyses.scamIndicators.count * 12, 100);
      score += scamScore * this.weights.scamIndicators;
      totalWeight += this.weights.scamIndicators;
    }

    // Urgency language
    if (analyses.urgencyLanguage.count > 0) {
      const urgencyScore = Math.min(analyses.urgencyLanguage.count * 20, 100);
      score += urgencyScore * this.weights.urgencyLanguage;
      totalWeight += this.weights.urgencyLanguage;
    }

    // Help requests (lower weight, but still concerning)
    if (analyses.helpRequests.count > 0) {
      const helpScore = Math.min(analyses.helpRequests.count * 8, 100);
      score += helpScore * this.weights.helpRequests;
      totalWeight += this.weights.helpRequests;
    }

    // Relationship money (concerning pattern)
    if (analyses.relationshipMoney.count > 0) {
      score += Math.min(analyses.relationshipMoney.count * 15, 100) * 0.15;
      totalWeight += 0.15;
    }

    // Temporal escalation bonus
    if (analyses.temporalPatterns?.hasEscalation) {
      score += 20; // Bonus for escalation pattern
    }

    // Normalize by total weight
    if (totalWeight > 0) {
      score = score / totalWeight;
    }

    // Cap at 100
    return Math.min(score, 100);
  }

  /**
   * Generate indicators
   */
  generateIndicators(analyses) {
    const indicators = [];

    if (analyses.largeAmounts.count > 0) {
      indicators.push({
        type: 'large_amounts',
        severity: analyses.largeAmounts.count > 2 ? 'high' : 'medium',
        message: `Mentioned large amounts of money ${analyses.largeAmounts.count} time(s)`
      });
    }

    if (analyses.transferMethods.count > 0) {
      indicators.push({
        type: 'transfer_methods',
        severity: 'high',
        message: `Discussed money transfer methods: ${analyses.transferMethods.phrases.join(', ')}`
      });
    }

    if (analyses.scamIndicators.count > 0) {
      indicators.push({
        type: 'scam_indicators',
        severity: 'high',
        message: `Mentioned potential scam keywords: ${analyses.scamIndicators.phrases.join(', ')}`
      });
    }

    if (analyses.urgencyLanguage.count > 0) {
      indicators.push({
        type: 'urgency_language',
        severity: 'high',
        message: `Used urgency/pressure language: ${analyses.urgencyLanguage.phrases.join(', ')}`
      });
    }

    if (analyses.relationshipMoney.count > 0) {
      indicators.push({
        type: 'relationship_money',
        severity: 'high',
        message: `Mentioned new relationships asking for money`
      });
    }

    if (analyses.temporalPatterns?.hasEscalation) {
      indicators.push({
        type: 'escalation',
        severity: 'high',
        message: `Financial topic mentions have increased over time`
      });
    }

    return indicators;
  }

  /**
   * Calculate confidence level
   */
  calculateConfidence(textLength, messageCount) {
    if (textLength < 500 || messageCount < 3) return 'low';
    if (textLength < 2000 || messageCount < 10) return 'medium';
    return 'high';
  }

  /**
   * Get default metrics
   */
  getDefaultMetrics() {
    return {
      riskScore: 0,
      confidence: 'none',
      indicators: [],
      largeAmountMentions: 0,
      transferMethodMentions: 0,
      scamIndicatorMentions: 0,
      urgencyMentions: 0,
      helpRequestMentions: 0,
      relationshipMoneyMentions: 0,
      temporalPatterns: { hasEscalation: false, trend: 'insufficient_data' },
      flaggedPhrases: []
    };
  }
}

module.exports = FinancialExploitationDetector;

