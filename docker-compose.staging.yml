# Staging override - uses staging environment with AWS secrets
services:
  bianca-app:
    image: 730335291008.dkr.ecr.us-east-2.amazonaws.com/bianca-app-backend:staging
    build:  # Disable build, use pre-built ECR image
      context: .
      dockerfile: Dockerfile
    environment:
      - NODE_ENV=staging
      - AWS_REGION=us-east-2
      - AWS_SECRET_ID=MySecretsManagerSecret
      # Base URLs for staging
      - API_BASE_URL=https://staging-api.myphonefriend.com
      - FRONTEND_URL=https://staging.myphonefriend.com
      - WEBSOCKET_URL=wss://staging-api.myphonefriend.com
      # MongoDB for staging (using containerized version)
      - MONGODB_URL=mongodb://mongodb:27017/bianca-service
    # Mount AWS credentials for secrets access
    volumes:
      - ~/.aws:/root/.aws:ro
    ports:
      - "3000:3000"
    cap_add:
      - NET_RAW
      - NET_ADMIN
    networks:
      - node-network

  mongodb:
    volumes:
      - /opt/mongodb-data:/data/db  # Mount EBS volume for data persistence

  asterisk:
    image: 730335291008.dkr.ecr.us-east-2.amazonaws.com/bianca-app-asterisk:staging
    environment:
      # These come from host environment (set by staging-userdata.sh from AWS Secrets)
      - ARI_PASSWORD=${ARI_PASSWORD}
      - BIANCA_PASSWORD=${BIANCA_PASSWORD}
      - EXTERNAL_ADDRESS=${EXTERNAL_ADDRESS}
      - RTP_START_PORT=10000
      - RTP_END_PORT=10100
      - ASTERISK_USERNAME=myphonefriend
    volumes:
      # Mount recordings for staging debugging
      - /opt/asterisk-recordings:/var/spool/asterisk/recording

# Define networks at the top level
networks:
  node-network:
    driver: bridge
