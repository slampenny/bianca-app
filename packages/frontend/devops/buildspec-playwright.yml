version: 0.2

env:
  variables:
    NODE_ENV: test
    API_BASE_URL: http://localhost:3000/v1
    MONGODB_URL: mongodb://localhost:27017/bianca-app-test

phases:
  pre_build:
    commands:
      - echo "Starting Playwright E2E test setup using Docker containers..."
      - echo "Setting up ECR registry..."
      - |
        # Get AWS account ID from STS if ECR_REGISTRY is not already set
        if [ -z "$ECR_REGISTRY" ]; then
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          if [ -z "$AWS_ACCOUNT_ID" ]; then
            echo "❌ ERROR: Could not determine AWS Account ID"
            exit 1
          fi
          export ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_DEFAULT_REGION}.amazonaws.com"
        fi
        echo "ECR Registry: $ECR_REGISTRY"
        echo "AWS Region: ${AWS_DEFAULT_REGION}"
      - echo "Logging in to Amazon ECR..."
      - aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY
      - echo "Pulling Docker images from ECR..."
      - |
        # Pull the staging images that were just built
        docker pull $ECR_REGISTRY/bianca-app-backend:staging
        docker pull $ECR_REGISTRY/bianca-app-frontend:staging
        echo "✅ Docker images pulled successfully"
      - echo "Installing Node.js 20 for Playwright..."
      - |
        # Install Node.js 20 using nvm (needed for Playwright)
        export NVM_DIR="$HOME/.nvm"
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm install 20
        nvm use 20
        echo "✅ Node.js 20 installed"
      - echo "Locating source code for Playwright tests..."
      - |
        # Source code is in CODEBUILD_SRC_DIR (from SourceOutput)
        echo "CODEBUILD_SRC_DIR: $CODEBUILD_SRC_DIR"
        FRONTEND_DIR="$CODEBUILD_SRC_DIR/packages/frontend"
        if [ ! -f "$FRONTEND_DIR/package.json" ]; then
          echo "ERROR: Frontend package.json not found"
          exit 1
        fi
        echo "✅ Frontend test code found at: $FRONTEND_DIR"
        export FRONTEND_DIR="$FRONTEND_DIR"
      - echo "Installing Playwright dependencies..."
      - |
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm use 20
        cd "$FRONTEND_DIR" || exit 1
        # Only install Playwright and its dependencies, not the entire app
        yarn install --frozen-lockfile --ignore-scripts || true
        yarn playwright install --with-deps chromium || exit 1
        echo "✅ Playwright installed"
      - echo "Starting MongoDB container..."
      - |
        docker run -d --name mongodb-test \
          -p 27017:27017 \
          -e MONGO_INITDB_DATABASE=bianca-app-test \
          mongo:7.0 || echo "MongoDB container may already exist"
        # Wait for MongoDB to be ready
        i=1
        while [ $i -le 30 ]; do
          if docker exec mongodb-test mongosh --eval "db.adminCommand('ping')" 2>/dev/null; then
            echo "✅ MongoDB is ready!"
            break
          fi
          sleep 1
          i=$((i + 1))
        done
        if [ $i -gt 30 ]; then
          echo "❌ MongoDB failed to start"
          exit 1
        fi
      - echo "Starting backend container..."
      - |
        # Start backend container with test configuration
        # Use host network so backend can access MongoDB on localhost:27017
        docker run -d --name backend-test \
          --network host \
          -e NODE_ENV=test \
          -e MONGODB_URL=mongodb://localhost:27017/bianca-app-test \
          -e AWS_REGION="$AWS_REGION" \
          -e AWS_SECRET_ID="$AWS_SECRET_ID" \
          -e FORCE_ETHEREAL=true \
          -e STRIPE_SECRET_KEY="$STRIPE_SECRET_KEY" \
          -e STRIPE_PUBLISHABLE_KEY="$STRIPE_PUBLISHABLE_KEY" \
          -e JWT_SECRET="$JWT_SECRET" \
          -e OPENAI_API_KEY="$OPENAI_API_KEY" \
          -e MFA_ENCRYPTION_KEY="$MFA_ENCRYPTION_KEY" \
          -e TWILIO_AUTHTOKEN="$TWILIO_AUTHTOKEN" \
          $ECR_REGISTRY/bianca-app-backend:staging
        # Wait for backend to be ready
        i=1
        while [ $i -le 60 ]; do
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "✅ Backend is ready!"
            break
          fi
          if [ $i -eq 60 ]; then
            echo "❌ Backend failed to start"
            docker logs backend-test || true
            exit 1
          fi
          sleep 2
          i=$((i + 1))
        done
      - echo "Seeding database..."
      - |
        sleep 3
        SEED_SUCCESS=false
        for attempt in 1 2 3; do
          echo "Seeding attempt $attempt..."
          SEED_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST http://localhost:3000/v1/test/seed)
          SEED_HTTP_CODE=$(echo "$SEED_RESPONSE" | tail -n1)
          if [ "$SEED_HTTP_CODE" = "200" ]; then
            echo "✅ Database seeded successfully"
            SEED_SUCCESS=true
            break
          else
            echo "⚠️  Seeding attempt $attempt failed with HTTP $SEED_HTTP_CODE"
            if [ $attempt -lt 3 ]; then
              sleep 5
            fi
          fi
        done
        if [ "$SEED_SUCCESS" = "false" ]; then
          echo "⚠️  Database seeding failed, but continuing..."
          docker logs backend-test | tail -50 || true
        fi
      - echo "Starting frontend container..."
      - |
        # Start frontend container
        # Use host network so frontend can access backend on localhost:3000
        docker run -d --name frontend-test \
          --network host \
          -e NODE_ENV=test \
          -e API_BASE_URL=http://localhost:3000/v1 \
          $ECR_REGISTRY/bianca-app-frontend:staging
        # Wait for frontend to be ready
        FRONTEND_READY=false
        i=1
        while [ $i -le 90 ]; do
          if curl -f -s http://localhost:8081 > /dev/null 2>&1; then
            if curl -f -s http://localhost:8081 | grep -q -i "html\|expo\|react" 2>/dev/null; then
              echo "✅ Frontend is ready!"
              FRONTEND_READY=true
              break
            fi
          fi
          if [ $i -eq 90 ]; then
            echo "❌ Frontend failed to start"
            docker logs frontend-test || true
            exit 1
          fi
          sleep 2
          i=$((i + 1))
        done
        if [ "$FRONTEND_READY" = "true" ]; then
          echo "Waiting 5 seconds for frontend to fully initialize..."
          sleep 5
        fi

  build:
    commands:
      - echo "Running Playwright E2E tests against Docker containers..."
      - |
        # Ensure Node.js 20 is available
        export NVM_DIR="$HOME/.nvm"
        [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
        nvm use 20
        # Re-export variables (they may not persist from pre_build)
        FRONTEND_DIR="$CODEBUILD_SRC_DIR/packages/frontend"
        export FRONTEND_DIR="$FRONTEND_DIR"
        
        echo "Frontend test code: $FRONTEND_DIR"
        echo "Node version: $(node --version)"
        cd "$FRONTEND_DIR" || exit 1
        
        # Set headless mode
        export PLAYWRIGHT_HEADLESS=1
        
        # Run Playwright tests
        echo "Running Playwright tests against containers..."
        set +e  # Don't exit on error, we'll handle it
        NODE_ENV=test npx playwright test --project=chromium --reporter=list > /tmp/playwright-output.log 2>&1
        TEST_EXIT_CODE=$?
        set -e  # Re-enable exit on error
        
        # Show output
        cat /tmp/playwright-output.log
        echo ""
        echo "Playwright exit code: $TEST_EXIT_CODE"
        
        if [ "$TEST_EXIT_CODE" -ne 0 ]; then
          echo "❌ Tests failed with exit code $TEST_EXIT_CODE"
          echo "=== Backend Container Logs ==="
          docker logs backend-test --tail 100 || true
          echo "=== Frontend Container Logs ==="
          docker logs frontend-test --tail 100 || true
          exit $TEST_EXIT_CODE
        fi
        echo "✅ All tests passed!"

  post_build:
    commands:
      - echo "Collecting test artifacts and logs..."
      - |
        # Create artifacts directory
        mkdir -p /tmp/playwright-artifacts
        
        # Copy Playwright reports and test results
        if [ -d "$FRONTEND_DIR/playwright-report" ]; then
          cp -r "$FRONTEND_DIR/playwright-report" /tmp/playwright-artifacts/ || true
        fi
        if [ -d "$FRONTEND_DIR/test-results" ]; then
          cp -r "$FRONTEND_DIR/test-results" /tmp/playwright-artifacts/ || true
        fi
        
        # Copy container logs
        docker logs backend-test > /tmp/playwright-artifacts/backend.log 2>&1 || true
        docker logs frontend-test > /tmp/playwright-artifacts/frontend.log 2>&1 || true
        if [ -f /tmp/playwright-output.log ]; then
          cp /tmp/playwright-output.log /tmp/playwright-artifacts/playwright-output.log || true
        fi
        
        # Create summary file
        {
          echo "Playwright Test Run Summary"
          echo "=========================="
          echo "Build ID: ${CODEBUILD_BUILD_ID}"
          echo "Build Number: ${CODEBUILD_BUILD_NUMBER}"
          echo "Source Version: ${CODEBUILD_SOURCE_VERSION}"
          echo "Start Time: ${CODEBUILD_START_TIME}"
          echo "Environment: ${NODE_ENV}"
          echo "Node Version: $(node --version)"
          echo "Yarn Version: $(yarn --version)"
          echo ""
          echo "Test Execution:"
          echo "- Exit Code: ${TEST_EXIT_CODE:-unknown}"
          echo "- Frontend: http://localhost:8081"
          echo "- Backend: http://localhost:3000"
          echo "- MongoDB: mongodb://localhost:27017/bianca-app-test"
          echo ""
          echo "Artifacts:"
          echo "- Playwright Report: playwright-report/index.html"
          echo "- Test Results: test-results/"
          echo "- Backend Log: backend.log"
          echo "- Frontend Log: frontend.log"
          echo "- Playwright Output: playwright-output.log"
        } > /tmp/playwright-artifacts/run-summary.txt
        
        # Copy artifacts to frontend directory for CodeBuild artifact collection
        cp -r /tmp/playwright-artifacts/* "$FRONTEND_DIR/" 2>/dev/null || true
        
        echo "✅ Artifacts collected"
        ls -la /tmp/playwright-artifacts/ || true
      - echo "Cleaning up Docker containers..."
      - |
        docker stop backend-test frontend-test mongodb-test 2>/dev/null || true
        docker rm backend-test frontend-test mongodb-test 2>/dev/null || true
      - echo "Test run completed"

artifacts:
  files:
    - '**/playwright-report/**/*'
    - '**/test-results/**/*'
    - '**/test-results/junit.xml'
    - '**/backend.log'
    - '**/frontend.log'
    - '**/playwright-output.log'
    - '**/run-summary.txt'
  base-directory: '**'
  name: PlaywrightTestResults

